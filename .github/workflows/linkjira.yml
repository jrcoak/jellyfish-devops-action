name: Link PR to Jira Issue

on:
  pull_request:
    types:
      - opened
    branches:
      - main  # Specify which branches you want to listen to PRs on

jobs:
  create_jira_issue:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Create Jira Issue
      id: create_jira
      run: |
        npm install axios
        
        # Call Jira API to create a new issue
        ISSUE_ID=$(node -e "
          const axios = require('axios');
          (async () => {
            try {
              const response = await axios.post('https://jellythijs.atlassian.net/rest/api/3/issue', {
                fields: {
                  project: { key: 'AGT' }, # Your Jira project key
                  summary: 'Issue Created By Joe's GH Action',     # Customize summary
                  issuetype: { name: 'Task' },     # Specify issue type
                }
              }, {
                headers: {
                  'Authorization': 'Basic ${process.env.JIRA_API_TOKEN}',
                  'Content-Type': 'application/json'
                }
              });
              console.log(response.data.key);
            } catch (error) {
              console.error('Error:', error.response ? error.response.data : error.message);
              process.exit(1);
            }
          })();
        ")
        echo "Issue ID: $ISSUE_ID"

    - name: Prepend Jira Issue to PR title
      run: |
        ISSUE_ID=$(echo ${{ steps.create_jira.outputs.issue_id }})
        PR_TITLE=$(gh pr view ${{ github.event.pull_request.number }} --json title --jq '.title')
        gh pr edit ${{ github.event.pull_request.number }} --title "[$ISSUE_ID] $PR_TITLE"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
